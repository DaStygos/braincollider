{% extends "base_generic.html" %}

{% block title %}Profil{% endblock %}

{% block content %}

{% load custom_tags %}
{% load static %}

<div class="row g-4">
  <!-- Colonne gauche: profil -->
  <div class="col-12 col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body text-center">
        <div class="mb-3">
          <img src="{{ user.profile.get_avatar_url }}" alt="Avatar" class="rounded-circle border"
               style="width: 120px; height: 120px; object-fit: cover;">
        </div>
        <h5 class="card-title mb-2">{{ user.username }}</h5>
        <p class="card-text text-muted mb-1">{{ user.email }}</p>
        <p class="card-text mb-0">
          <small>Membre depuis le {{ user.date_joined|date:"d/m/Y H:i" }}</small>
        </p>
        <div class="mt-4">
          <canvas id="scoreChart" width="250" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Colonne droite: soumissions -->
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Mes soumissions</h5>
        <span class="badge bg-light text-primary">
          Score total : {{ total_score }} point{{ total_score|pluralize }}
        </span>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Problème</th>
              <th class="text-center" style="width: 160px;">Difficulté</th>
              <th class="text-center" style="width: 80px;">Statut</th>
              <th class="text-center" style="width: 120px;">Score</th>
            </tr>
          </thead>
          <tbody>
            {% if submissions %}
              {% for submission in submissions %}
                {% with submission.problem.difficulty|stars as st %}
                  <tr>
                    <td>
                      <a href="{% url 'problems:problem_detail' submission.problem.id %}"
                         class="text-decoration-none fw-semibold text-dark">
                        {{ submission.problem.title }}
                      </a>
                    </td>
                    <td class="text-center">
                      {% for s in st %}
                        <span class="text-warning fs-5">{{ s }}</span>
                      {% endfor %}
                    </td>
                    <td class="text-center">
                      {% if submission.is_correct == True %}
                        <i class="bi bi-check-circle-fill text-success fs-5" title="Correcte"></i>
                      {% elif submission.is_correct == False %}
                        <i class="bi bi-x-circle-fill text-danger fs-5" title="Incorrecte"></i>
                      {% else %}
                        <i class="bi bi-hourglass-split text-warning fs-5" title="En attente de correction"></i>
                      {% endif %}
                    </td>
                    <td class="text-center text-dark">
                      {{ submission.problem.get_score }} pt{{ submission.problem.get_score|pluralize }}
                    </td>
                  </tr>
                {% endwith %}
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted p-3">
                  Vous n'avez soumis aucune réponse pour le moment.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const ctx = document.getElementById('scoreChart');
    
    // Récupérer les données depuis Django
    const labels = {{ chart_labels|safe }};
    const scores = {{ chart_data|safe }};

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Score',
          data: scores,
          borderWidth: 2,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 10
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  </script>

{% endblock %}


{% endblock %}